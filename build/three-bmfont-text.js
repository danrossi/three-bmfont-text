"use strict";function createCommonjsModule(t,e){return e={exports:{}},t(e,e.exports),e.exports}function extend(){for(var t={},e=0;e<arguments.length;e++){var n=arguments[e];for(var i in n)hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t}function TextLayout(t){this.glyphs=[],this._measure=this.computeMetrics.bind(this),this.update(t)}function addGetter(t){Object.defineProperty(TextLayout.prototype,t,{get:wrapper(t),configurable:!0})}function wrapper(t){return new Function(["return function "+t+"() {","  return this._"+t,"}"].join("\n"))()}function getGlyphById(t,e){if(!t.chars||0===t.chars.length)return null;var n=findChar(t.chars,e);return n>=0?t.chars[n]:null}function getXHeight(t){for(var e=0;e<X_HEIGHTS.length;e++){var n=X_HEIGHTS[e].charCodeAt(0),i=findChar(t.chars,n);if(i>=0)return t.chars[i].height}return 0}function getMGlyph(t){for(var e=0;e<M_WIDTHS.length;e++){var n=M_WIDTHS[e].charCodeAt(0),i=findChar(t.chars,n);if(i>=0)return t.chars[i]}return 0}function getCapHeight(t){for(var e=0;e<CAP_HEIGHTS.length;e++){var n=CAP_HEIGHTS[e].charCodeAt(0),i=findChar(t.chars,n);if(i>=0)return t.chars[i].height}return 0}function getKerning(t,e,n){if(!t.kernings||0===t.kernings.length)return 0;for(var i=t.kernings,r=0;r<i.length;r++){var a=i[r];if(a.first===e&&a.second===n)return a.amount}return 0}function getAlignType(t){return"center"===t?ALIGN_CENTER:"right"===t?ALIGN_RIGHT:ALIGN_LEFT}function findChar(t,e,n){for(var i=n=n||0;i<t.length;i++)if(t[i].id===e)return i;return-1}function bounds(t){var e=t.length/itemSize;box.min[0]=t[0],box.min[1]=t[1],box.max[0]=t[0],box.max[1]=t[1];for(var n=0;n<e;n++){var i=t[n*itemSize+0],r=t[n*itemSize+1];box.min[0]=Math.min(i,box.min[0]),box.min[1]=Math.min(r,box.min[1]),box.max[0]=Math.max(i,box.max[0]),box.max[1]=Math.max(r,box.max[1])}}Object.defineProperty(exports,"__esModule",{value:!0});var THREE=require("three"),classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),inherits=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},possibleConstructorReturn=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},BaseShader=function(){function t(){classCallCheck(this,t)}return createClass(t,null,[{key:"uniforms",value:function(t,e,n){return{opacity:{type:"f",value:n},map:{type:"t",value:t||new THREE.Texture},color:{type:"c",value:new THREE.Color(e)}}}},{key:"discarOnAlphaTest",value:function(t){return t>0?" if (gl_FragColor.a < "+t+") discard;":""}},{key:"createShader",value:function(t){var e=this,n=(t=t||{}).color,i=t.map,r=t.precision,a="number"==typeof t.opacity?t.opacity:1,o="number"==typeof t.alphaTest?t.alphaTest:1e-4;return delete t.map,delete t.color,delete t.precision,delete t.opacity,Object.assign({uniforms:e.uniforms(i,n,a),vertexShader:e.vertexShader,fragmentShader:e.fragmentShader(r,o)},t)}},{key:"vertexShader",get:function(){return"\n\t      attribute vec2 uv;\n\t      attribute vec4 position;\n\t      uniform mat4 projectionMatrix;\n\t      uniform mat4 modelViewMatrix;\n\t      varying vec2 vUv;\n\t      void main() {\n\t        vUv = uv;\n\t        gl_Position = projectionMatrix * modelViewMatrix * position;\n\t      }\n\t    "}}]),t}(),MSDFShader=function(t){function e(){return classCallCheck(this,e),possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return inherits(e,BaseShader),createClass(e,null,[{key:"fragmentShader",value:function(t,e){var n=BaseShader.discarOnAlphaTest(e);return"\n      #ifdef GL_OES_standard_derivatives\n        #extension GL_OES_standard_derivatives : enable\n      #endif\n      precision "+(t||"highp")+" float;\n      uniform float opacity;\n      uniform vec3 color;\n      uniform sampler2D map;\n      varying vec2 vUv;\n\n      float median(float r, float g, float b) {\n        return max(min(r, g), min(max(r, g), b));\n      }\n\n      void main() {\n        vec3 sample = texture2D(map, vUv).rgb;\n        float sigDist = median(sample.r, sample.g, sample.b) - 0.5;\n        float alpha = clamp(sigDist/fwidth(sigDist) + 0.5, 0.0, 1.0);\n        gl_FragColor = vec4(color.xyz, alpha * opacity);\n        "+n+"\n      }\n    "}}]),e}(),BasicShader=function(t){function e(){return classCallCheck(this,e),possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return inherits(e,BaseShader),createClass(e,null,[{key:"fragmentShader",value:function(t,e){var n=BaseShader.discarOnAlphaTest(e);return"\n      precision "+(t||"highp")+" float;\n      uniform float opacity;\n      uniform vec3 color;\n      uniform sampler2D map;\n      varying vec2 vUv;\n\n      void main() {\n        gl_FragColor = texture2D(map, vUv) * vec4(color, opacity);\n        "+n+"\n      }\n    "}}]),e}(),Vertices=function(){function t(){classCallCheck(this,t)}return createClass(t,null,[{key:"pages",value:function(t,e,n){var i=t.page||0;e[n++]=i,e[n++]=i,e[n++]=i,e[n++]=i}},{key:"geomData",value:function(t,e,n){var i=new Float32Array(8*t.length),r=new Float32Array(8*t.length),a=new Uint16Array(6*t.length),o=0,s=0,u=0;return t.forEach(function(t){var h=t.data,l=h.width,c=h.height,p=h.x+l,f=h.y+c,d=e.common.scaleW,m=e.common.scaleH,g=h.x/d,v=p/d,y=h.y/m,x=f/m;n&&(y=(m-h.y)/m,x=(m-f)/m);var b=t.position[0]+h.xoffset,_=t.position[1]+h.yoffset,T=_+c,E=b+l;r[o]=b,i[o]=g,r[o+1]=_,i[o+1]=y,r[o+2]=b,i[o+2]=g,r[o+3]=T,i[o+3]=x,r[o+4]=E,i[o+4]=v,r[o+5]=T,i[o+5]=x,r[o+6]=E,i[o+6]=v,r[o+7]=_,i[o+7]=y,a[s+0]=u+0,a[s+1]=u+1,a[s+2]=u+2,a[s+3]=u+0,a[s+4]=u+2,a[s+5]=u+3,o+=8,s+=6,u+=4}),{uvs:i,positions:r,index:a}}}]),t}(),index$1=createCommonjsModule(function(t){function e(t,e,n,i){var r=t.indexOf(e,n);return-1===r||r>i?i:r}function n(t){return u.test(t)}function i(t,e,n,i,r){for(var a=[],s=n,u=n;u<i&&u<e.length;u++){var h=e.charAt(u),l=o.test(h);if(l||u===i-1){var c=t(e,s,l?u:u+1,r);a.push(c),s=u+1}}return a}function r(t,i,r,a,o,u){var h=[],l=o;for("nowrap"===u&&(l=Number.MAX_VALUE);r<a&&r<i.length;){for(var c=e(i,s,r,a);r<c&&n(i.charAt(r));)r++;var p=t(i,r,c,l),f=r+(p.end-p.start),d=f+s.length;if(f<c){for(;f>r&&!n(i.charAt(f));)f--;if(f===r)d>r+s.length&&d--,f=d;else for(d=f;f>r&&n(i.charAt(f-s.length));)f--}if(f>=r){var m=t(i,r,f,l);h.push(m)}r=d}return h}function a(t,e,n,i){return{start:e,end:e+Math.min(i,n-e)}}var o=/\n/,s="\n",u=/\s/;t.exports=function(e,n){return t.exports.lines(e,n).map(function(t){return e.substring(t.start,t.end)}).join("\n")},t.exports.lines=function(t,e){if(0===(e=e||{}).width&&"nowrap"!==e.mode)return[];t=t||"";var n="number"==typeof e.width?e.width:Number.MAX_VALUE,o=Math.max(0,e.start||0),s="number"==typeof e.end?e.end:t.length,u=e.mode,h=e.measure||a;return"pre"===u?i(h,t,o,s,n):r(h,t,o,s,n,u)}}),index_1=index$1.lines,immutable=extend,hasOwnProperty=Object.prototype.hasOwnProperty,index$3=function(t,e){return"number"==typeof t?t:"number"==typeof e?e:0},X_HEIGHTS=["x","e","a","o","n","s","r","c","u","m","v","w","z"],M_WIDTHS=["m","w"],CAP_HEIGHTS=["H","I","N","E","F","K","L","T","U","V","W","X","Y","Z"],TAB_ID="\t".charCodeAt(0),SPACE_ID=" ".charCodeAt(0),ALIGN_LEFT=0,ALIGN_CENTER=1,ALIGN_RIGHT=2,index=function(t){return new TextLayout(t)};TextLayout.prototype.update=function(t){if(t=immutable({measure:this._measure},t),this._opt=t,this._opt.tabSize=index$3(this._opt.tabSize,4),!t.font)throw new Error("must provide a valid bitmap font");var e=this.glyphs,n=t.text||"",i=t.font;this._setupSpaceGlyphs(i);var r=index$1.lines(n,t),a=t.width||0;e.length=0;var o=r.reduce(function(t,e){return Math.max(t,e.width,a)},0),s=0,u=0,h=index$3(t.lineHeight,i.common.lineHeight),l=i.common.base,c=h-l,p=t.letterSpacing||0,f=h*r.length-c,d=getAlignType(this._opt.align);u-=f,this._width=o,this._height=f,this._descender=h-l,this._baseline=l,this._xHeight=getXHeight(i),this._capHeight=getCapHeight(i),this._lineHeight=h,this._ascender=h-c-this._xHeight;var m=this;r.forEach(function(t,r){for(var a,l=t.start,c=t.end,f=t.width,g=l;g<c;g++){var v=n.charCodeAt(g),y=m.getGlyph(i,v);if(y){a&&(s+=getKerning(i,a.id,y.id));var x=s;d===ALIGN_CENTER?x+=(o-f)/2:d===ALIGN_RIGHT&&(x+=o-f),e.push({position:[x,u],data:y,index:g,line:r}),s+=y.xadvance+p,a=y}}u+=h,s=0}),this._linesTotal=r.length},TextLayout.prototype._setupSpaceGlyphs=function(t){if(this._fallbackSpaceGlyph=null,this._fallbackTabGlyph=null,t.chars&&0!==t.chars.length){var e=getGlyphById(t,SPACE_ID)||getMGlyph(t)||t.chars[0],n=this._opt.tabSize*e.xadvance;this._fallbackSpaceGlyph=e,this._fallbackTabGlyph=immutable(e,{x:0,y:0,xadvance:n,id:TAB_ID,xoffset:0,yoffset:0,width:0,height:0})}},TextLayout.prototype.getGlyph=function(t,e){var n=getGlyphById(t,e);return n||(e===TAB_ID?this._fallbackTabGlyph:e===SPACE_ID?this._fallbackSpaceGlyph:null)},TextLayout.prototype.computeMetrics=function(t,e,n,i){var r,a,o=this._opt.letterSpacing||0,s=this._opt.font,u=0,h=0,l=0;if(!s.chars||0===s.chars.length)return{start:e,end:e,width:0};n=Math.min(t.length,n);for(var c=e;c<n;c++){var p=t.charCodeAt(c);if(r=this.getGlyph(s,p)){r.xoffset;var f=(u+=a?getKerning(s,a.id,r.id):0)+r.xadvance+o,d=u+r.width;if(d>=i||f>=i)break;u=f,h=d,a=r}l++}return a&&(h+=a.xoffset),{start:e,end:e+l,width:h}},["width","height","descender","ascender","xHeight","baseline","capHeight","lineHeight"].forEach(addGetter);var itemSize=2,box={min:[0,0],max:[0,0]},TextGeometryUtil=function(){function t(){classCallCheck(this,t)}return createClass(t,null,[{key:"computeBox",value:function(t,e){bounds(t),e.min.set(box.min[0],box.min[1],0),e.max.set(box.max[0],box.max[1],0)}},{key:"computeSphere",value:function(t,e){bounds(t);var n=box.min[0],i=box.min[1],r=box.max[0]-n,a=box.max[1]-i,o=Math.sqrt(r*r+a*a);e.center.set(n+r/2,i+a/2,0),e.radius=o/2}}]),t}(),TextGeometry=function(t){function e(t){classCallCheck(this,e);var n=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n._opt=Object.assign({},t),n.boundingBox=new THREE.Box3,t&&n.update(t),n}return inherits(e,t),createClass(e,[{key:"update",value:function(t){"string"==typeof t&&(t={text:t}),t=Object.assign({},this._opt,t),this.layout=index(t);var e=!1!==t.flipY,n=t.font,i=this.layout.glyphs;this.visibleGlyphs=i;var r=Vertices.geomData(i,n,e);if(this.setIndex(new THREE.BufferAttribute(r.index,1)),this.attributes.position?(this.attributes.position=new THREE.BufferAttribute(r.positions,2),this.attributes.uv=new THREE.BufferAttribute(r.uvs,2),this.index.needsUpdate=!0,this.attributes.position.needsUpdate=!0,this.attributes.uv.needsUpdate=!0):(this.addAttribute("position",new THREE.BufferAttribute(r.positions,2)),this.addAttribute("uv",new THREE.BufferAttribute(r.uvs,2))),!t.multipage&&"page"in this.attributes)this.removeAttribute("page");else if(t.multipage){var a=Vertices.pages(i);this.addAttribute("uv",new THREE.BufferAttribute(a,1))}}},{key:"computeBoundingSphere",value:function(){null===this.boundingSphere&&(this.boundingSphere=new THREE.Sphere);var t=this.attributes.position.array,e=this.attributes.position.itemSize;if(!t||!e||t.length<2)return this.boundingSphere.radius=0,void this.boundingSphere.center.set(0,0,0);TextGeometryUtil.computeSphere(t,this.boundingSphere)}},{key:"computeBoundingBox",value:function(){var t=this.boundingBox,e=this.attributes.position.array,n=this.attributes.position.itemSize;!e||!n||e.length<2?t.makeEmpty():TextGeometryUtil.computeBox(e,t)}}]),e}(THREE.BufferGeometry),TextBitmap=function(){function t(e,n){classCallCheck(this,t),e.color=e.color||"#fff",e.lineHeight=e.lineHeight?e.font.common.lineHeight+e.lineHeight:e.font.common.lineHeight,this.config=e,this.init(e,n)}return createClass(t,[{key:"init",value:function(t,e){var n=this.geometry=new TextGeometry(t),i=t.texture;this.initTexture(i,e);var r=new THREE.RawShaderMaterial(MSDFShader.createShader({side:THREE.DoubleSide,transparent:!0,depthTest:!1,map:i,color:t.color})),a=this.mesh=new THREE.Mesh(n,r),o=this.group=new THREE.Group;a.renderOrder=1,a.rotation.x=Math.PI;var s=t.scale||1;o.scale.set(s,s,s),o.add(a),this.createHitBox(t),this.update()}},{key:"createHitBox",value:function(t){var e=new THREE.BoxBufferGeometry(1,1,1),n=new THREE.RawShaderMaterial(BasicShader.createShader({color:16711680,transparent:!0,opacity:t.showHitBox?1:0,wireframe:!0})),i=this.hitBox=new THREE.Mesh(e,n);i.mesh=this.mesh,this.group.add(i)}},{key:"initTexture",value:function(t,e){t.needsUpdate=!0,t.minFilter=THREE.LinearMipMapLinearFilter,t.magFilter=THREE.LinearFilter,t.generateMipmaps=!0,t.anisotropy=e.capabilities.getMaxAnisotropy()}},{key:"update",value:function(){var t=this.geometry,e=this.mesh;t.computeBoundingBox(),e.position.x=-t.layout.width/2,e.position.y=-(t.boundingBox.max.y-t.boundingBox.min.y)/2,this.hitBox.scale.set(t.layout.width,t.layout.height,1),this.hitBox.position.y=-t.layout.height/2,this.height=t.layout.height*this.config.scale}},{key:"text",get:function(){return this.config.text},set:function(t){this.config.text=t,this.geometry.update(this.config),this.update()}}]),t}();exports.MSDFShader=MSDFShader,exports.TextBitmap=TextBitmap;
