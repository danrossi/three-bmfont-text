!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],e):e(t.BmFont={},t.THREE)}(this,function(t,e){"use strict";function n(t){var e=t.length/g;d.min[0]=t[0],d.min[1]=t[1],d.max[0]=t[0],d.max[1]=t[1];for(var n=0;n<e;n++){var i=t[n*g+0],r=t[n*g+1];d.min[0]=Math.min(i,d.min[0]),d.min[1]=Math.min(r,d.min[1]),d.max[0]=Math.max(i,d.max[0]),d.max[1]=Math.max(r,d.max[1])}}var i=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},r=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),o=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},a=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},s=function(){function t(){i(this,t)}return r(t,null,[{key:"uniforms",value:function(t,n,i){return{opacity:{type:"f",value:i},map:{type:"t",value:t||new e.Texture},color:{type:"c",value:new e.Color(n)}}}},{key:"discarOnAlphaTest",value:function(t){return t>0?" if (gl_FragColor.a < "+t+") discard;":""}},{key:"createShader",value:function(t){var e=this,n=(t=t||{}).color,i=t.map,r=t.precision,o="number"==typeof t.opacity?t.opacity:1,a="number"==typeof t.alphaTest?t.alphaTest:1e-4;return delete t.map,delete t.color,delete t.precision,delete t.opacity,Object.assign({uniforms:e.uniforms(i,n,o),vertexShader:e.vertexShader,fragmentShader:e.fragmentShader(r,a)},t)}},{key:"vertexShader",get:function(){return"\n\t      attribute vec2 uv;\n\t      attribute vec4 position;\n\t      uniform mat4 projectionMatrix;\n\t      uniform mat4 modelViewMatrix;\n\t      varying vec2 vUv;\n\t      void main() {\n\t        vUv = uv;\n\t        gl_Position = projectionMatrix * modelViewMatrix * position;\n\t      }\n\t    "}}]),t}(),u=function(t){function e(){return i(this,e),a(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return o(e,s),r(e,null,[{key:"fragmentShader",value:function(t,e){var n=s.discarOnAlphaTest(e);return"\n      #ifdef GL_OES_standard_derivatives\n        #extension GL_OES_standard_derivatives : enable\n      #endif\n      precision "+(t||"highp")+" float;\n      uniform float opacity;\n      uniform vec3 color;\n      uniform sampler2D map;\n      varying vec2 vUv;\n\n      float median(float r, float g, float b) {\n        return max(min(r, g), min(max(r, g), b));\n      }\n\n      void main() {\n        vec3 sample = texture2D(map, vUv).rgb;\n        float sigDist = median(sample.r, sample.g, sample.b) - 0.5;\n        float alpha = clamp(sigDist/fwidth(sigDist) + 0.5, 0.0, 1.0);\n        gl_FragColor = vec4(color.xyz, alpha * opacity);\n        "+n+"\n      }\n    "}}]),e}(),h=function(t){function e(){return i(this,e),a(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return o(e,s),r(e,null,[{key:"fragmentShader",value:function(t,e){var n=s.discarOnAlphaTest(e);return"\n      precision "+(t||"highp")+" float;\n      uniform float opacity;\n      uniform vec3 color;\n      uniform sampler2D map;\n      varying vec2 vUv;\n\n      void main() {\n        gl_FragColor = texture2D(map, vUv) * vec4(color, opacity);\n        "+n+"\n      }\n    "}}]),e}(),c=function(t,e){return e={exports:{}},t(e,e.exports),e.exports}(function(t){function e(t,e,n,i){var r=t.indexOf(e,n);return-1===r||r>i?i:r}function n(t){return u.test(t)}function i(t,e,n,i,r){for(var o=[],s=n,u=n;u<i&&u<e.length;u++){var h=e.charAt(u),c=a.test(h);if(c||u===i-1){var f=t(e,s,c?u:u+1,r);o.push(f),s=u+1}}return o}function r(t,i,r,o,a,u){var h=[],c=a;for("nowrap"===u&&(c=Number.MAX_VALUE);r<o&&r<i.length;){for(var f=e(i,s,r,o);r<f&&n(i.charAt(r));)r++;var l=t(i,r,f,c),p=r+(l.end-l.start),g=p+s.length;if(p<f){for(;p>r&&!n(i.charAt(p));)p--;if(p===r)g>r+s.length&&g--,p=g;else for(g=p;p>r&&n(i.charAt(p-s.length));)p--}if(p>=r){var d=t(i,r,p,c);h.push(d)}r=g}return h}function o(t,e,n,i){return{start:e,end:e+Math.min(i,n-e)}}var a=/\n/,s="\n",u=/\s/;t.exports=function(e,n){return t.exports.lines(e,n).map(function(t){return e.substring(t.start,t.end)}).join("\n")},t.exports.lines=function(t,e){if(0===(e=e||{}).width&&"nowrap"!==e.mode)return[];t=t||"";var n="number"==typeof e.width?e.width:Number.MAX_VALUE,a=Math.max(0,e.start||0),s="number"==typeof e.end?e.end:t.length,u=e.mode,h=e.measure||o;return"pre"===u?i(h,t,a,s,n):r(h,t,a,s,n,u)}}),f=(c.lines,function(){function t(){i(this,t)}return r(t,null,[{key:"pages",value:function(t,e,n){var i=t.page||0;e[n]=i,e[n+1]=i,e[n+2]=i,e[n+3]=i}},{key:"uvs",value:function(t,e,n,i,r){var o=t.x+t.width,a=t.y+t.height,s=i.common.scaleW,u=i.common.scaleH,h=t.x/s,c=o/s,f=t.y/u,l=a/u;r&&(f=(u-t.y)/u,l=(u-a)/u),e[n]=h,e[n+1]=f,e[n+2]=h,e[n+3]=l,e[n+4]=c,e[n+5]=l,e[n+6]=c,e[n+7]=f}},{key:"index",value:function(t,e,n){t[e]=n,t[e+1]=n+1,t[e+2]=n+2,t[e+3]=n+0,t[e+4]=n+2,t[e+5]=n+3}},{key:"geomData",value:function(t,e,n){var i=new Float32Array(8*t.length),r=new Float32Array(8*t.length),o=new Uint16Array(6*t.length),a=0,s=0,u=0,h=0;return t.forEach(function(t){var c=t.data,f=c.width,l=c.height,p=c.x+f,g=c.y+l,d=e.common.scaleW,m=e.common.scaleH,y=c.x/d,v=p/d,x=c.y/m,_=g/m;n&&(x=(m-c.y)/m,_=(m-g)/m);var b=t.position[0]+c.xoffset,w=t.position[1]+c.yoffset,k=w+l,B=b+f;r[a]=b,i[s]=y,r[a+1]=w,i[s+1]=x,r[a+2]=b,i[s+2]=y,r[a+3]=k,i[s+3]=_,r[a+4]=B,i[s+4]=v,r[a+5]=k,i[s+5]=_,r[a+6]=B,i[s+6]=v,r[a+7]=w,i[s+7]=x,o[u]=h,o[u+1]=h+1,o[u+2]=h+2,o[u+3]=h+0,o[u+4]=h+2,o[u+5]=h+3,a+=8,s+=8,u+=6,h+=4}),{uvs:i,positions:r,index:o}}},{key:"positions",value:function(t,e,n,i,r){var o=i+t.xoffset,a=r+t.yoffset,s=t.width,u=t.height;e[n]=o,e[n+1]=a,e[n+2]=o,e[n+3]=a+u,e[n+4]=o+s,e[n+5]=a+u,e[n+6]=o+s,e[n+7]=a}}]),t}()),l=function(){function t(){i(this,t)}return r(t,null,[{key:"getGlyphById",value:function(t,e){return t.charsmap[e]?t.chars[t.charsmap[e]]:null}},{key:"getKerning",value:function(t,e,n){return t.kerningsmap[e.id+e.index+n.id+n.index]||0}}]),t}(),p=function(){function t(e){i(this,t),this._glyphs=[],this._positions=[],this._uvs=[],this._pages=[],this._opt=e,this.update(e)}return r(t,[{key:"initBuffers",value:function(t){var e=8*t.length;this._positions=new Float32Array(e),this._uvs=new Float32Array(e),this._indices=new Uint16Array(6*t.length)}},{key:"update",value:function(t,e){var n=this;t.align=t.align||"left",this._opt.measure=function(t,e,i,r){return n.computeMetrics(t,e,i,r)},this._opt.tabSize=this._opt.tabSize>0?this._opt.tabSize:4;var i=t.text||"",r=this.font,o=c.lines(i,this._opt),a=t.width||0,s=this.lineHeight,u=this.letterSpacing,h=(this._pages,0),p=0,g=0,d=0;this.initBuffers(i),t.multipage&&(this._pages=new Uint16Array(4*i.length)),this._glyphCount=0,this._width=o.reduce(function(t,e){return Math.max(t,e.width,a)},0),this._height=this.lineHeight*o.length-this.descender;var m=0,y=-this._height;o.forEach(function(t,e){for(var o=t.start,a=t.end,c=t.width,v=n.getAlignment(c),x=null,_=o;_<a;_++){var b=l.getGlyphById(r,i.charCodeAt(_));if(b){x&&(m+=l.getKerning(r,x,b));var w=m;w+=v,b.width*b.height>0&&(n._glyphCount++,f.positions(b,n._positions,h,w,y),f.uvs(b,n._uvs,h,n.font,n._opt.flipY),f.index(n._indices,p,g),b.page&&(f.pages(b,n._pages,d),d+=4),p+=6,g+=4,h+=8,n._drawRange=h),m+=b.xadvance+u,x=b}}y+=s,m=0}),this._linesTotal=o.length}},{key:"getAlignment",value:function(t){switch(this._opt.align){case"center":return(this._width-t)/2;case"right":return this._width-t;default:return 0}}},{key:"computeMetrics",value:function(t,e,n,i){var r=this.letterSpacing,o=this.font,a=0,s=0,u=0,h=null;if(!o.chars||0===o.chars.length)return{start:e,end:e,width:0};for(var c=e;c<Math.min(t.length,n);c++){var f=l.getGlyphById(o,t.charCodeAt(c));if(f){f.xoffset;var p=(a+=h?l.getKerning(o,h,f):0)+f.xadvance+r,g=a+f.width;if(g>=i||p>=i)break;a=p,s=g,h=f}u++}return h&&(s+=h.xoffset),{start:e,end:e+u,width:s}}},{key:"pages",get:function(){return new Float32Array(this._pages,0,4*this.glyphs.length*1)}},{key:"positions",get:function(){return this._positions}},{key:"uvs",get:function(){return this._uvs}},{key:"indices",get:function(){return this._indices}},{key:"glyphCount",get:function(){return this._glyphCount}},{key:"drawRange",get:function(){return this._drawRange}},{key:"font",get:function(){return this._opt.font}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"lineHeight",get:function(){return this._opt.lineHeight||this.font.common.lineHeight}},{key:"baseline",get:function(){return this.font.common.base}},{key:"descender",get:function(){return this.lineHeight-this.baseline}},{key:"ascender",get:function(){return this.lineHeight-descender-this.xHeight}},{key:"xHeight",get:function(){return this.font.common.xHeight}},{key:"capHeight",get:function(){return this.font.common.capHeight}},{key:"letterSpacing",get:function(){return this._opt.letterSpacing||0}}]),t}(),g=2,d={min:[0,0],max:[0,0]},m=function(){function t(){i(this,t)}return r(t,null,[{key:"computeBox",value:function(t,e){n(t),e.min.set(d.min[0],d.min[1],0),e.max.set(d.max[0],d.max[1],0)}},{key:"computeSphere",value:function(t,e){n(t);var i=d.min[0],r=d.min[1],o=d.max[0]-i,a=d.max[1]-r,s=Math.sqrt(o*o+a*a);e.center.set(i+o/2,r+a/2,0),e.radius=s/2}}]),t}(),y=function(t){function n(t){i(this,n);var r=a(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return r._opt=Object.assign({flipY:!0},t),r.boundingBox=new e.Box3,r.update(t.text),r}return o(n,t),r(n,[{key:"creatTextLayout",value:function(){return new p(this._opt)}},{key:"update",value:function(t){var n=this._opt;n.text=t,this.layout=this.creatTextLayout(),this.setIndex(new e.BufferAttribute(this.layout.indices,1)),this.setDrawRange(0,this.layout.drawRange);var i=new e.BufferAttribute(this.layout.positions,2),r=new e.BufferAttribute(this.layout.uvs,2);if(this.attributes.position?(this.attributes.position=i,this.attributes.uv=r,this.index.needsUpdate=!0,this.attributes.position.needsUpdate=!0,this.attributes.uv.needsUpdate=!0):(this.addAttribute("position",i),this.addAttribute("uv",r)),n.multipage){var o=new e.BufferAttribute(this.layout.pages,1);this.attributes.page?(this.attributes.page=o,this.attributes.page.needsUpdate=!0):this.addAttribute("page",o)}}},{key:"computeBoundingSphere",value:function(){null===this.boundingSphere&&(this.boundingSphere=new e.Sphere);var t=this.attributes.position.array,n=this.attributes.position.itemSize;if(!t||!n||t.length<2)return this.boundingSphere.radius=0,void this.boundingSphere.center.set(0,0,0);m.computeSphere(t,this.boundingSphere)}},{key:"computeBoundingBox",value:function(){var t=this.boundingBox,e=this.attributes.position.array,n=this.attributes.position.itemSize;!e||!n||e.length<2?t.makeEmpty():m.computeBox(e,t)}}]),n}(e.BufferGeometry),v=function(){function t(e,n){i(this,t),e.color=e.color||"#fff",e.lineHeight=e.lineHeight?e.font.common.lineHeight+e.lineHeight:e.font.common.lineHeight,this.config=e,this._text=null,this.init(e,n)}return r(t,[{key:"createGeometry",value:function(){return new y(this.config)}},{key:"init",value:function(t,n){var i=this.geometry=this.createGeometry(),r=t.texture;this.initTexture(r,n);var o=new e.RawShaderMaterial(u.createShader({side:e.DoubleSide,transparent:!0,depthTest:!1,map:r,color:t.color})),a=this.mesh=new e.Mesh(i,o),s=this.group=new e.Group;a.renderOrder=1,a.rotation.x=Math.PI;var h=t.scale||1;s.scale.set(h,h,h),s.add(a),this.createHitBox(t),this.update()}},{key:"createHitBox",value:function(t){var n=new e.BoxBufferGeometry(1,1,1),i=new e.RawShaderMaterial(h.createShader({color:16711680,transparent:!0,opacity:t.showHitBox?1:0,wireframe:!0})),r=this.hitBox=new e.Mesh(n,i);r.mesh=this.mesh,this.group.add(r)}},{key:"initTexture",value:function(t,n){t.needsUpdate=!0,t.minFilter=e.LinearMipMapLinearFilter,t.magFilter=e.LinearFilter,t.generateMipmaps=!0,t.anisotropy=n.capabilities.getMaxAnisotropy()}},{key:"update",value:function(){var t=this.geometry,e=this.mesh;t.computeBoundingBox(),e.position.x=-t.layout.width/2,e.position.y=-(t.boundingBox.max.y-t.boundingBox.min.y)/2,this.hitBox.scale.set(t.layout.width,t.layout.height,1),this.hitBox.position.y=-t.layout.height/2,this.height=t.layout.height*this.config.scale}},{key:"text",get:function(){return this._text},set:function(t){this._text=t,this.geometry.update(t),this.update()}}]),t}(),x=function(t){function e(t){return i(this,e),a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t))}return o(e,p),r(e,[{key:"update",value:function(t,e){this._height=this.lineHeight-this.descender,this._width=t.width;var n=l.getGlyphById(t.font,t.text.charCodeAt(0)),i=-this._height,r=t.text,o=0;this.initBuffers(r),n.width*n.height>0&&(o=this.getAlignment(n.width),f.positions(n,this._positions,0,o,i),f.uvs(n,this._uvs,0,this.font,this._opt.flipY),f.index(this._indices,0,0),this._drawRange=8)}}]),e}(),_=function(t){function e(t){return i(this,e),a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t))}return o(e,y),r(e,[{key:"creatTextLayout",value:function(){return new x(this._opt)}}]),e}(),b=function(t){function e(t,n){return i(this,e),a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n))}return o(e,v),r(e,[{key:"createGeometry",value:function(){return new _(this.config)}}]),e}();t.TextBitmap=v,t.SimpleTextBitmap=b,Object.defineProperty(t,"__esModule",{value:!0})});
