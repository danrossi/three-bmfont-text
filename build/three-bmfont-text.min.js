!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],e):e(t.BmFont={},t.THREE)}(this,function(t,e){"use strict";function i(t,e,i,n){var r=t.indexOf(e,i);return-1===r||r>n?n:r}function n(t){return d.test(t)}function r(t,e,r,o,a){for(var s=[],u=a;r<o&&r<e.length;){for(var h=i(e,g,r,o);r<h&&n(e.charAt(r));)r++;var c=t(e,r,h,u),f=r+(c.end-c.start),l=f+g.length;if(f<h){for(;f>r&&!n(e.charAt(f));)f--;if(f===r)l>r+g.length&&l--,f=l;else for(l=f;f>r&&n(e.charAt(f-g.length));)f--}if(f>=r){var p=t(e,r,f,u);s.push(p)}r=l}return s}function o(t){var e=t.length/v;_.min[0]=t[0],_.min[1]=t[1],_.max[0]=t[0],_.max[1]=t[1];for(var i=0;i<e;i+=1){var n=t[i*v],r=t[i*v+1];_.min[0]=Math.min(n,_.min[0]),_.min[1]=Math.min(r,_.min[1]),_.max[0]=Math.max(n,_.max[0]),_.max[1]=Math.max(r,_.max[1])}}var a=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},s=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),u=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},h=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},c=function(){function t(){a(this,t)}return s(t,null,[{key:"uniforms",value:function(t,i,n){return{opacity:{type:"f",value:n},map:{type:"t",value:t||new e.Texture},color:{type:"c",value:new e.Color(i)}}}},{key:"discarOnAlphaTest",value:function(t){return t>0?" if (gl_FragColor.a < "+t+") discard;":""}},{key:"createShader",value:function(t){var e=this,i=(t=t||{}).color,n=t.map,r=t.precision,o="number"==typeof t.opacity?t.opacity:1,a="number"==typeof t.alphaTest?t.alphaTest:1e-4;return delete t.map,delete t.color,delete t.precision,delete t.opacity,Object.assign({uniforms:e.uniforms(n,i,o),vertexShader:e.vertexShader,fragmentShader:e.fragmentShader(r,a)},t)}},{key:"vertexShader",get:function(){return"\n\t      attribute vec2 uv;\n\t      attribute vec4 position;\n\t      uniform mat4 projectionMatrix;\n\t      uniform mat4 modelViewMatrix;\n\t      varying vec2 vUv;\n\t      void main() {\n\t        vUv = uv;\n\t        gl_Position = projectionMatrix * modelViewMatrix * position;\n\t      }\n\t    "}}]),t}(),f=function(t){function e(){return a(this,e),h(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return u(e,c),s(e,null,[{key:"fragmentShader",value:function(t,e){var i=c.discarOnAlphaTest(e);return"\n      #ifdef GL_OES_standard_derivatives\n        #extension GL_OES_standard_derivatives : enable\n      #endif\n      precision "+(t||"highp")+" float;\n      uniform float opacity;\n      uniform vec3 color;\n      uniform sampler2D map;\n      varying vec2 vUv;\n\n      float median(float r, float g, float b) {\n        return max(min(r, g), min(max(r, g), b));\n      }\n\n      void main() {\n        vec3 sample = texture2D(map, vUv).rgb;\n        float sigDist = median(sample.r, sample.g, sample.b) - 0.5;\n        float alpha = clamp(sigDist/fwidth(sigDist) + 0.5, 0.0, 1.0);\n        gl_FragColor = vec4(color.xyz, alpha * opacity);\n        "+i+"\n      }\n    "}}]),e}(),l=function(t){function e(){return a(this,e),h(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return u(e,c),s(e,null,[{key:"fragmentShader",value:function(t,e){var i=c.discarOnAlphaTest(e);return"\n      precision "+(t||"highp")+" float;\n      uniform float opacity;\n      uniform vec3 color;\n      uniform sampler2D map;\n      varying vec2 vUv;\n\n      void main() {\n        gl_FragColor = texture2D(map, vUv) * vec4(color, opacity);\n        "+i+"\n      }\n    "}}]),e}(),p=function(){function t(){a(this,t)}return s(t,null,[{key:"pages",value:function(t,e,i){var n=t.page||0;e[i]=n,e[i+1]=n,e[i+2]=n,e[i+3]=n}},{key:"uvs",value:function(t,e,i,n,r){var o=t.x+t.width,a=t.y+t.height,s=n.common.scaleW,u=n.common.scaleH,h=t.x/s,c=o/s,f=t.y/u,l=a/u;r&&(f=(u-t.y)/u,l=(u-a)/u),e[i]=h,e[i+1]=f,e[i+2]=h,e[i+3]=l,e[i+4]=c,e[i+5]=l,e[i+6]=c,e[i+7]=f}},{key:"index",value:function(t,e,i){t[e]=i,t[e+1]=i+1,t[e+2]=i+2,t[e+3]=i+0,t[e+4]=i+2,t[e+5]=i+3}},{key:"positions",value:function(t,e,i,n,r){var o=n+t.xoffset,a=r+t.yoffset,s=t.width,u=t.height;e[i]=o,e[i+1]=a,e[i+2]=o,e[i+3]=a+u,e[i+4]=o+s,e[i+5]=a+u,e[i+6]=o+s,e[i+7]=a}}]),t}(),g="\n",d=/\s/,y=function(){function t(){a(this,t)}return s(t,null,[{key:"getGlyphById",value:function(t,e){return t.chars[t.charsmap[e]]}},{key:"getKerning",value:function(t,e,i){return t.kerningsmap[e.id+e.index+i.id+i.index]||0}},{key:"wordwrap",value:function(t,e){return e=e||{},r(e.measure,t,e.start||0,e.end||t.length,e.width||50)}}]),t}(),m=function(){function t(e){a(this,t),this._glyphs=[],this._positions=[],this._uvs=[],this._pages=[],this._opt=e,this.update(e)}return s(t,[{key:"initBuffers",value:function(t){var e=8*t.length;this._positions=new Float32Array(e),this._uvs=new Float32Array(e),this._indices=new Uint16Array(6*t.length)}},{key:"update",value:function(t,e){var i=this;t.align=t.align||"left",this._opt.measure=function(t,e,n,r){return i.computeMetrics(t,e,n,r)},this._opt.tabSize=this._opt.tabSize>0?this._opt.tabSize:4;var n=t.text||"",r=this.font,o=y.wordwrap(n,this._opt),a=t.width||0,s=this.lineHeight,u=this.letterSpacing,h=(this._pages,0),c=0,f=0,l=0;this.initBuffers(n),t.multipage&&(this._pages=new Uint16Array(4*n.length)),this._glyphCount=0,this._width=o.reduce(function(t,e){return Math.max(t,e.width,a)},0),this._height=this.lineHeight*o.length-this.descender;var g=0,d=0;o.forEach(function(t,e){for(var o=t.start,a=t.end,m=t.width,v=i.getAlignment(m),_=null,x=o;x<a;x++){var b=y.getGlyphById(r,n.charCodeAt(x));if(b){_&&(g+=y.getKerning(r,_,b));var w=g;w+=v,b.width*b.height>0&&(i._glyphCount++,p.positions(b,i._positions,h,w,d),p.uvs(b,i._uvs,h,i.font,i._opt.flipY),p.index(i._indices,c,f),b.page&&(p.pages(b,i._pages,l),l+=4),c+=6,f+=4,h+=8,i._drawRange=h),g+=b.xadvance+u,_=b}}d+=s,g=0}),this._linesTotal=o.length}},{key:"getAlignment",value:function(t){switch(this._opt.align){case"center":return(this._width-t)/2;case"right":return this._width-t;default:return 0}}},{key:"computeMetrics",value:function(t,e,i,n){var r=this.letterSpacing,o=this.font,a=0,s=0,u=0,h=null;if(!o.chars||0===o.chars.length)return{start:e,end:e,width:0};for(var c=e;c<Math.min(t.length,i);c++){var f=y.getGlyphById(o,t.charCodeAt(c));if(f){f.xoffset;var l=(a+=h?y.getKerning(o,h,f):0)+f.xadvance+r,p=a+f.width;if(p>=n||l>=n)break;a=l,s=p,h=f}u++}return h&&(s+=h.xoffset),{start:e,end:e+u,width:s}}},{key:"pages",get:function(){return new Float32Array(this._pages,0,4*this.glyphs.length*1)}},{key:"positions",get:function(){return this._positions}},{key:"uvs",get:function(){return this._uvs}},{key:"indices",get:function(){return this._indices}},{key:"glyphCount",get:function(){return this._glyphCount}},{key:"drawRange",get:function(){return this._drawRange}},{key:"font",get:function(){return this._opt.font}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"lineHeight",get:function(){return this._opt.lineHeight||this.font.common.lineHeight}},{key:"baseline",get:function(){return this.font.common.base}},{key:"descender",get:function(){return this.lineHeight-this.baseline}},{key:"ascender",get:function(){return this.lineHeight-descender-this.xHeight}},{key:"xHeight",get:function(){return this.font.common.xHeight}},{key:"capHeight",get:function(){return this.font.common.capHeight}},{key:"letterSpacing",get:function(){return this._opt.letterSpacing||0}}]),t}(),v=2,_={min:[0,0],max:[0,0]},x=function(){function t(){a(this,t)}return s(t,null,[{key:"computeBox",value:function(t,e){o(t),e.min.set(_.min[0],_.min[1],0),e.max.set(_.max[0],_.max[1],0)}},{key:"computeSphere",value:function(t,e){o(t);var i=_.min[0],n=_.min[1],r=_.max[0]-i,a=_.max[1]-n,s=Math.sqrt(r*r+a*a);e.center.set(i+r/2,n+a/2,0),e.radius=s/2}}]),t}(),b=function(t){function i(t){a(this,i);var n=h(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return n._opt=Object.assign({flipY:!0},t),n.boundingBox=new e.Box3,n.update(t.text),n}return u(i,t),s(i,[{key:"creatTextLayout",value:function(){return new m(this._opt)}},{key:"update",value:function(t){var i=this._opt;i.text=t,this.layout=this.creatTextLayout(),this.setIndex(new e.BufferAttribute(this.layout.indices,1)),this.setDrawRange(0,this.layout.drawRange);var n=new e.BufferAttribute(this.layout.positions,2),r=new e.BufferAttribute(this.layout.uvs,2);if(this.attributes.position?(this.attributes.position=n,this.attributes.uv=r,this.index.needsUpdate=!0,this.attributes.position.needsUpdate=!0,this.attributes.uv.needsUpdate=!0):(this.addAttribute("position",n),this.addAttribute("uv",r)),i.multipage){var o=new e.BufferAttribute(this.layout.pages,1);this.attributes.page?(this.attributes.page=o,this.attributes.page.needsUpdate=!0):this.addAttribute("page",o)}}},{key:"computeBoundingSphere",value:function(){null===this.boundingSphere&&(this.boundingSphere=new e.Sphere);var t=this.attributes.position.array,i=this.attributes.position.itemSize;if(!t||!i||t.length<2)return this.boundingSphere.radius=0,void this.boundingSphere.center.set(0,0,0);x.computeSphere(t,this.boundingSphere)}},{key:"computeBoundingBox",value:function(){var t=this.boundingBox,e=this.attributes.position.array,i=this.attributes.position.itemSize;!e||!i||e.length<2?t.makeEmpty():x.computeBox(e,t)}}]),i}(e.BufferGeometry),w=function(){function t(e,i){a(this,t),e.color=e.color||"#fff",e.lineHeight=e.lineHeight?e.font.common.lineHeight+e.lineHeight:e.font.common.lineHeight,this.config=e,this._text=null,this.init(e,i)}return s(t,[{key:"createGeometry",value:function(){return new b(this.config)}},{key:"init",value:function(t,i){var n=this.geometry=this.createGeometry(),r=t.texture;this.initTexture(r,i);var o=new e.RawShaderMaterial(f.createShader({side:e.DoubleSide,transparent:!0,depthTest:!1,map:r,color:t.color})),a=this.mesh=new e.Mesh(n,o),s=this.group=new e.Group;a.renderOrder=1,this.rotateMesh(a);var u=t.scale||1;s.scale.set(u,u,u),s.add(a),this.createHitBox(t),this.update()}},{key:"rotateMesh",value:function(t){t.rotation.x=Math.PI}},{key:"createHitBox",value:function(t){var i=new e.BoxBufferGeometry(1,1,1),n=new e.RawShaderMaterial(l.createShader({color:16711680,transparent:!0,opacity:t.showHitBox?1:0,wireframe:!0})),r=this.hitBox=new e.Mesh(i,n);r.mesh=this.mesh,this.group.add(r)}},{key:"initTexture",value:function(t,i){t.needsUpdate=!0,t.minFilter=e.LinearMipMapLinearFilter,t.magFilter=e.LinearFilter,t.generateMipmaps=!0,t.anisotropy=i.capabilities.getMaxAnisotropy()}},{key:"update",value:function(){var t=this.geometry,e=this.mesh;t.computeBoundingBox(),e.position.x=-t.layout.width/2,e.position.y=-(t.boundingBox.max.y-t.boundingBox.min.y)/2,this.hitBox.scale.set(t.layout.width,t.layout.height,1),this.height=t.layout.height*this.config.scale}},{key:"text",get:function(){return this._text},set:function(t){this._text=t,this.geometry.update(t),this.update()}}]),t}(),k=function(t){function e(t){return a(this,e),h(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t))}return u(e,m),s(e,[{key:"update",value:function(t,e){this._height=this.lineHeight-this.descender,this._width=t.width;var i=y.getGlyphById(t.font,t.text.charCodeAt(0)),n=t.text,r=0,o=-this._height/2/2;this.initBuffers(n),i.width*i.height>0&&(this._width=i.width+6,r=-6,p.positions(i,this._positions,0,r,o),p.uvs(i,this._uvs,0,this.font,this._opt.flipY),p.index(this._indices,0,0),this._drawRange=8)}}]),e}(),S=function(t){function e(t){return a(this,e),h(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t))}return u(e,b),s(e,[{key:"creatTextLayout",value:function(){return new k(this._opt)}}]),e}(),B=function(t){function e(t,i){return a(this,e),h(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i))}return u(e,w),s(e,[{key:"createGeometry",value:function(){return new S(this.config)}},{key:"rotateMesh",value:function(){}}]),e}();t.TextBitmap=w,t.SingleTextBitmap=B,Object.defineProperty(t,"__esModule",{value:!0})});
